<template>
  <div class="qualifies-form-wrapper attest-form">
    <slot name="title"/>
    <div style="height: 10px"/>
    <a-form v-bind="formItemLayout" :form="form" autocomplete="off" v-if="userType ==='org'">
      <a-form-item :label="org.name.label">
        <a-select v-decorator="org.name.dec" v-bind="org.name.other">
          <a-select-option v-for="i in nameOption" :key="i.id" :value="i.creditCode">{{i.name}}</a-select-option>
        </a-select>
      </a-form-item>
      <a-form-item :label="org.code.label">
        <a-input v-decorator="org.code.dec" style="display: none"/>
        <span :class="codeClass">{{ relation.codeText }}</span>
      </a-form-item>
      <a-form-item :label="org.identity.label">
        <a-textarea v-decorator="org.identity.dec" v-bind="org.identity.other"/>
      </a-form-item>
      <a-form-item :label="org.email.label">
        <a-input v-decorator="org.email.dec" v-bind="org.email.other"/>
      </a-form-item>
      <a-form-item :label="org.buEmail.label">
        <a-input v-decorator="org.buEmail.dec" v-bind="org.buEmail.other"/>
      </a-form-item>
      <a-form-item :label="org.license.label">
        <div class="fill-form-upload-wrapper">
          <a-upload v-decorator="org.license.dec" v-bind="org.letter.other" class="upload-wrapper">
            <div class="upload-container">
              <a-icon type="plus" />
            </div>
          </a-upload>
          <div class="upload-text">
            <div>*支持jpg、pdf格式</div>
          </div>
        </div>
      </a-form-item>
      <a-form-item :label="org.letter.label">
        <div class="fill-form-upload-wrapper">
          <a-upload v-decorator="org.letter.dec" v-bind="org.letter.other" class="upload-wrapper">
            <div class="upload-container">
              <a-icon type="plus" />
            </div>
          </a-upload>
          <div class="upload-text">
            <div>*请下载保密承诺函模板，签字、用印后扫描或拍照上传；支持jpg、pdf格式</div>
            <a href="#">承诺函模板下载</a>
          </div>
        </div>
      </a-form-item>
    </a-form>
    <a-form v-bind="formItemLayout" :form="form" autocomplete="off" v-if="userType ==='lawyer'">
      <a-form-item :label="law.name.label">
        <a-input v-decorator="law.name.dec" v-bind="law.name.other"/>
        <span class="normal">{{ username }}</span>
      </a-form-item>
      <a-form-item :label="law.idNumber.label">
        <a-input v-decorator="law.idNumber.dec" v-bind="law.idNumber.other"/>
      </a-form-item>
      <a-form-item :label="law.sex.label">
        <a-radio-group v-decorator="law.sex.dec">
          <a-radio value="0">男</a-radio>
          <a-radio value="1">女</a-radio>
        </a-radio-group>
      </a-form-item>
      <a-form-item :label="law.cardNo.label">
        <a-input v-decorator="law.cardNo.dec" v-bind="law.cardNo.other"/>
      </a-form-item>
      <a-form-item :label="law.year.label">
        <a-select v-decorator="law.year.dec" v-bind="law.year.other">
          <a-select-option v-for="i in yearOption" :value="i.value" :key="i.value">{{i.value}}年</a-select-option>
        </a-select>
      </a-form-item>
      <a-form-item :label="law.office.label">
        <a-input v-decorator="law.office.dec" v-bind="law.office.other"/>
        <span class="form-item-remark">*请在签约前完善律所信息</span>
      </a-form-item>
      <a-form-item :label="law.email.label">
        <a-input v-decorator="law.email.dec" v-bind="law.email.other"/>
      </a-form-item>
      <a-form-item :label="law.buEmail.label">
        <a-input v-decorator="law.buEmail.dec" v-bind="law.buEmail.other"/>
      </a-form-item>
      <a-form-item :label="law.card.label" >
        <div class="fill-form-upload-wrapper fill-form-upload__block" style="padding-left: 200px">
          <a-upload v-decorator="law.card.decA" v-bind="law.card.other" class="upload-wrapper">
            <div class="upload-container"  v-if="!fileLists.cardFront">
              <a-icon type="plus" />
            </div>
          </a-upload>
          <div class="upload-text">证件正面（国徽面）</div>
        </div>
        <div class="fill-form-upload-wrapper fill-form-upload__remark">
          <div class="upload-text">*支持jpg、pdf格式</div>
        </div>
      </a-form-item>
      <a-form-item class="fill-form-upload__card" :wrapperCol="{span:24}">
        <div class="fill-form-upload-wrapper fill-form-upload__block">
          <a-upload v-decorator="law.card.decB" v-bind="law.card.other" class="upload-wrapper">
            <div class="upload-container"  v-if="!fileLists.cardBack">
              <a-icon type="plus" />
            </div>
          </a-upload>
          <div class="upload-text">证件正面（人像面）</div>
        </div>
      </a-form-item>
      <a-form-item :label="law.cert.label">
        <div class="fill-form-upload-wrapper">
          <a-upload v-decorator="law.cert.dec" v-bind="law.cert.other" class="upload-wrapper">
            <div class="upload-container">
              <a-icon type="plus" />
            </div>
          </a-upload>
          <div class="upload-text">
            <div>*支持jpg、pdf格式</div>
          </div>
        </div>
      </a-form-item>
      <a-form-item :label="law.letter.label">
        <div class="fill-form-upload-wrapper">
          <a-upload v-decorator="law.letter.dec" v-bind="law.letter.other" class="upload-wrapper">
            <div class="upload-container">
              <a-icon type="plus" />
            </div>
          </a-upload>
          <div class="upload-text">
            <div>*请下载保密承诺函模板，签字、用印后扫描或拍照上传；支持jpg、pdf格式</div>
            <a href="#" style="text-decoration: underline">承诺函模板下载</a>
          </div>
        </div>
      </a-form-item>
    </a-form >
    <a-form-item label=" " v-bind="formItemLayout" class="form-item-no-title" v-if="noAuction">
      <a-space >
        <a-button type="primary" @click="handleSubmit" v-if="append">确认无误并提交</a-button>
        <template v-else>
          <a-button type="primary">保存</a-button>
          <a-button >取消</a-button>
        </template>
      </a-space>
    </a-form-item>
  </div>
</template>

<script>
import { qualifies } from "@/plugin/api/attest";
import { fileListRule } from "@/plugin/tools";

const formItemLayout = {
  labelCol: { span: 8 },
  wrapperCol: { span: 16 },
};

const baseWidth = { style:{width:'442px'}};

const nameOption = [
  { id :1, name:'杭州杭州湾建筑劳务有限公司',creditCode:'91330104747171289M'},
  { id :2, name:'安然数据科技有限公司1',creditCode:'91110112MA01AGNJ8Y'},
  { id :3, name:'安然数据科技有限公司2',creditCode:''},
];

const yearOption = (()=>{
  const minYear = 1980;
  const maxYear = new Date().getFullYear() + 5;
  const length = maxYear - minYear < 0 ? 50 : maxYear - minYear;
  return new Array(length).fill(1).map((i,index)=>({value:(minYear + length - index).toString()}))
})();

export default {
  name: 'FillForm',
  nameComment: '机构或律师（表单填写）',
  props:{
    userType:{
      type:String,
      default:'lawyer'
    },
    append:{
      type:Boolean,
      default:true
    },
    source: Object,
    noAuction:{
      type:Boolean,
      default:false
    },
  },
  data() {
    const validateCard = (rule, value, callback) => {
      if (value === '') {
        callback(new Error('身份证号码不能为空'));
      } else {
        const reg = new RegExp(
          /^[1-9]\d{5}(18|19|20|(3\d))\d{2}((0[1-9])|(1[0-2]))(([0-2][1-9])|10|20|30|31)\d{3}[0-9Xx]$/);
        if(!reg.test(value)) callback('请输入有效的身份号码');
        callback();
      }
    };
    return {
      formItemLayout,
      nameOption,
      yearOption,
      org:{
        name:{
          label:'机构名称',
          dec:['name',{
              initialValue:'',
              rules: [ { required: true, message: '机构名称不能为空！' } ],
              change: this.handleOrgChange,
            },
          ],
          other:{
            allowClear:true,
            labelInValue: true,
            showSearch: true,
            optionFilterProp: "children",
            showArrow: false,
            filterOption: (input, option) => option.componentOptions.children[0].text.toLowerCase().indexOf(input.toLowerCase()) >= 0,
            autoComplete:'off',
            placeholder:'请输入机构名称',
            ...baseWidth,
          }
        },
        code:{
          label:'统一社会信用代码',
          dec:['orgSocialCreditCode'],
        },
        identity:{
          label:'合伙人身份',
          dec:['partnerDetail'],
          other:{
            autoComplete:'off',
            placeholder:'若为合伙企业请明确执行事务合伙人身份',
            autoSize:{ minRows: 4 },
            ...baseWidth,
          }
        },
        email:{
          label:'邮箱地址',
          dec:['email', {
            rules: [
                { type: 'email',message: '请输入正确的邮箱地址！'},
                { required: true, message: '邮箱地址不能为空!' },
            ]},
          ],
          other:{
            placeholder:'请输入邮箱地址',
            ...baseWidth,
          }
        },
        buEmail:{
          label:'备用邮箱',
          dec:[ 'backupEmail', {
              rules: [{ type: 'email',message: '请输入正确的邮箱地址！' }],
            },
          ],
          other:{
            placeholder:'请输入备用的邮箱地址',
            ...baseWidth,
          }
        },
        license:{
          label:'营业执照',
          dec:[ 'businessLicense', {
            valuePropName: 'fileList',
            getValueFromEvent: this.normFile,
            rules: [
              { required: true, message: '请上传营业执照!' },
            ]
          },
          ],
          other:{
            beforeUpload:()=>false,
            listType:"picture-card",
            accept:'application/pdf,image/*',
          }
        },
        letter:{
          label:'保密承诺函',
          dec:[ 'confidentialityCommitmentLetter', {
            valuePropName: 'fileList',
            getValueFromEvent: this.normFile,
            rules: [ { required: true, message: '请上传保密承诺函!' },
            ]
          }],
          other:{
            beforeUpload:()=>false,
            listType:"picture-card",
            accept:'application/pdf,image/*',
          }
        },
      },
      law:{
        name:{
          label:'律师姓名',
          dec:[ 'lawyerName'],
          other:{
            style:{
              display:'none',
              width:'442px'
            }
          }
        },
        idNumber:{
          label:'身份证号码',
          dec:[ 'cardNumber', {
            trigger:'blur',
            rules: [ { validator: validateCard }]
          }],
          other:{
            placeholder:'请输入身份证号码',
            maxLength:18,
            ...baseWidth
          }
        },
        sex:{
          label:'性别',
          dec:[ 'sex', {
            rules: [
              { required: true, message: '请选择性别！' },
            ]
          }],
        },
        cardNo:{
          label:'执业证号',
          dec:[ 'licenseNumber', {
            rules: [
              { required: true, message: '执业证号不能为空!' },
            ]
          }],
          other:{
            placeholder:'请输入执业证号',
            ...baseWidth
          }
        },
        year:{
          label:'执业开始年份',
          dec:[ 'licenseStart',{
            rules: [
              { required: true, message: '执业开始年份不能为空！' },
            ]
          }],
          other:{
            allowClear:true,
            placeholder:'请选择年份',
            style:{
              width:'152px'
            }
          }
        },
        office:{
          label:'挂靠律所',
          dec:[ 'lawOffice'],
          other:{
            placeholder:'请输入挂靠律所',
            ...baseWidth,
          }
        },
        email:{
          label:'邮箱地址',
          dec:['email', {
            rules: [
              { type: 'email',message: '请输入正确的邮箱地址！' },
              { required: true, message: '邮箱地址不能为空!' },
            ],
          }],
          other:{
            placeholder:'请输入邮箱地址',
            ...baseWidth,
          }
        },
        buEmail:{
          label:'备用邮箱',
          dec:['backupEmail', {
            rules: [
              { type: 'email',message: '请输入正确的邮箱地址！' },
            ]},
          ],
          other:{
            placeholder:'请输入备用的邮箱地址',
            ...baseWidth,
          }
        },
        card:{
          label:'身份证照片',
          decA:[ 'frontOfCard', {
            valuePropName: 'fileList',
            getValueFromEvent: e=>this.normFile(e,'cardFront'),
            rules: [
              { required: true, message: '请上传身份证照片!' },
            ]
          }],
          decB:[ 'backOfCard', {
            valuePropName: 'fileList',
            getValueFromEvent: e=>this.normFile(e,'cardBack'),
          }],
          other:{
            beforeUpload:()=>false,
            listType:"picture-card",
          }
        },
        cert:{
          label:'从业资格证',
          dec:[ 'qualificationCertificate', {
            valuePropName: 'fileList',
            getValueFromEvent: this.normFile,
            rules: [
              { required: true, message: '请上传从业资格证!' },
            ]
          }],
          other:{
            beforeUpload:()=>false,
            listType:"picture-card",
          }
        },
        letter:{
          label:'保密承诺函',
          dec:[ 'confidentialityCommitmentLetter', {
            valuePropName: 'fileList',
            getValueFromEvent: this.normFile,
            rules: [
              { required: true, message: '请上传保密承诺函!' },
            ]
          },
          ],
          other:{
            beforeUpload:()=>false,
            listType:"picture-card",
          }
        },

      },
      fileLists:{
        cardFront:0,
        cardBack:0,
      },
      // 联动字段属性
      relation:{
        codeStatus:'hint',
        codeText:' 自动匹配所选机构的统一社会信用代码',
      },
    };
  },
  created() {
    this.form = this.$form.createForm(this);
  },
  methods:{
    // 下拉搜索相关逻辑
    handleOrgChange(option = {}) {
      const orgSocialCreditCode = option.key || '';
      if(Object.keys(option).length){
        this.relation = orgSocialCreditCode ? {
          codeStatus:'normal',
          codeText:orgSocialCreditCode
        } : {
          codeStatus:'error',
          codeText:'当前机构名称并未匹配到，社会统一社会信用代码'
        };
      }else{
        this.relation = {
          codeStatus:'hint',
          codeText:'自动匹配所选机构的统一社会信用代码'
        }
      }
      this.form.setFieldsValue({ orgSocialCreditCode });
      // if(option.key)
    },
    normFile(e,field) {
      console.log('Upload event:', e);
      if (Array.isArray(e)) { return e }
      this.fileLists = {
        ...this.fileLists,
        [field]:e.fileList.length,
      };
      return e && e.fileList;
    },
    // 确认无误并提交
    handleSubmit(e) {
      e.preventDefault();
      this.form.validateFields((err, values) => {
        if (!err) {
          console.log('Received values of form: ', values);
          this.toUpdateInfo(values)
        }
      });
    },
    // 变更认证信息
    toUpdateInfo(source){
      const _source = this.processData(source);
      const addApi = this.userType === 'lawyer' ? qualifies.lawyerAdd : qualifies.orgAdd;
      addApi(_source).then(res=>{
        if(res.code === 20000 ){
          console.log(res);
          if(this.toTellRes){
            this.$emit.toTellRes(res)
          }
        }
      })
    },
    // 处理当前数据
    processData(source = {}){
      if(this.userType === 'org') {
        return Object.assign({},source,{
          confidentialityCommitmentLetter:'https://qiniu.yczcjk.com/123.png',
          businessLicense:'https://qiniu.yczcjk.com/123.png',
          name:(source.name || {}).label
        })
      }else{
        const _source = Object.assign({},source,{
          frontOfCard:'https://qiniu.yczcjk.com/123.png',
          backOfCard:'https://qiniu.yczcjk.com/123.png',
          qualificationCertificate:'https://qiniu.yczcjk.com/123.png',
          confidentialityCommitmentLetter:'https://qiniu.yczcjk.com/123.png',
        });
        return {lawyerQualify:{..._source}}
      }
    },
  },
  computed:{
    codeClass:function () {
      if(this.relation.codeStatus === 'hint') return 'text-remark';
      if(this.relation.codeStatus === 'error') return 'text-error';
      else return 'normal';
    },
    username(){
      return this.$store.getters.getInfo.username;
    },
  },
  mounted(){
    // console.log(this.$store.getters.getInfo.username);
    const lawyerName = this.$store.getters.getInfo.username;
    if(this.form && this.userType === 'lawyer'){
      this.form.setFieldsValue({ lawyerName })
    }

    if(Object.keys(this.source).length){
      const {
        backOfCard:bc, frontOfCard:fc, confidentialityCommitmentLetter:cc, qualificationCertificate:qc, ..._source
      } = this.source;
      const fieldValues = {
        ..._source,
        backOfCard:fileListRule(bc),
        frontOfCard:fileListRule(fc),
        confidentialityCommitmentLetter:fileListRule(cc),
        qualificationCertificate:fileListRule(qc),
      };
      delete fieldValues.contact;
      delete fieldValues.logId;
      delete fieldValues.createTime;
      delete fieldValues.phone;
      this.fileLists = {
        cardFront:fileListRule(fc).length,
        cardBack:fileListRule(bc).length,
      };
      this.form.setFieldsValue({...fieldValues})
    }
  }
}
</script>

<style lang='scss'>
.qualifies-form-wrapper{
  .fill-form-upload{
    &__remark{
      display: inline-block;
      vertical-align: bottom;
      margin-bottom: 38px;
    }
    &__block{
      display: inline-block;
    }
    &-wrapper{
      .upload-wrapper{
        overflow: hidden;
        display: inline;
        .ant-upload-select-picture-card{
          width: 184px;
          height: 104px;
        }
        .upload-container{
          width: 184px;
          display: table-cell;
          vertical-align: middle;
          i{
            color: rgba(0, 0, 0, 0.25);
            font-size: 30px;
            transition: all 0.3s;
          }
        }
        .ant-upload-list-picture-card-container{
          width: 184px;
          .ant-upload-list-item{
            width: 184px;
          }
        }

      }
      .upload-text{
        line-height: 20px;
        font-size: 12px;
      }
    }
    &__card{
      margin-bottom: 0;
      .ant-form-item-control{
        position: absolute;
        top: -162px;
        left:33.333%;
      }
    }
  }
  .form-item-remark{
    margin-left: 10px;
    color: $text-remark;
  }

}
</style>
